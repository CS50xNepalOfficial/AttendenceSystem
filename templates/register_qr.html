{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  #html5-qrcode-button-camera-permission {
    font-weight: bolder;
    border: 2px solid #dc2626;
    background: #dc2626;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.3s;
  }
  
  #html5-qrcode-button-camera-permission:hover {
    background: #b91c1c;
    border-color: #b91c1c;
  }
  
  .next-btn {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #dc2626;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    width: 100%;
    transition: all 0.3s;
  }
  
  .next-btn:hover {
    background-color: #b91c1c;
  }
</style>

<div class="container mx-auto mt-20">
  <div class="cs50-card backdrop-blur-lg bg-gray-900/50 text-white mx-auto mt-8 p-8 rounded-xl shadow-lg max-w-md">
    <h1 class="text-3xl font-bold text-center mb-6">QR Registration</h1>

    <!-- Success Message -->
    <div id="success-message" class="hidden bg-green-900/50 border border-green-500 text-green-400 px-4 py-3 rounded-lg relative mb-6" role="alert">
      <strong class="font-bold">Success!</strong>
      <span class="block sm:inline" id="success-text"></span>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="hidden bg-red-900/50 border border-red-500 text-red-400 px-4 py-3 rounded-lg relative mb-6" role="alert">
      <strong class="font-bold">Error!</strong>
      <span class="block sm:inline" id="error-text"></span>
    </div>

    <!-- Event Selection -->
    <select name="event" id="event" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-red-500 focus:border-transparent mb-4">
      <option value="" disabled selected>Select Event</option>
      {% for event in events %}
        <option value="{{ event.id }}">{{ event.name }} - {{ event.date|date:"M d, Y" }}</option>
      {% endfor %}
    </select>

    <!-- QR Code Section -->
    <div class="flex justify-center mb-6 mt-4">
      <div class="w-72 h-72 bg-gray-800 rounded-lg shadow-inner flex items-center justify-center border border-gray-700">
        <div id="reader" class="w-full h-full"></div>
      </div>
    </div>

    <script src="{% static 'js/html5-qrcode.min.js' %}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const eventSelect = document.getElementById('event');
        let html5QrcodeScanner;

        // Start QR scanner when event is selected
        eventSelect.addEventListener('change', function() {
          const selectedEventId = eventSelect.value;
          if (selectedEventId) {
            if (!html5QrcodeScanner) {
              html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 });
              html5QrcodeScanner.render(onScanSuccess);
            }
          }
        });

        function onScanSuccess(decodedText, decodedResult) {
          const selectedEventId = eventSelect.value;
          
          if (!selectedEventId) {
            document.getElementById('error-text').innerText = 'Please select an event first';
            document.getElementById('error-message').classList.remove('hidden');
            return;
          }

          const data = {
            unique_id: decodedText,
            event_id: selectedEventId
          };

          fetch("{% url 'register_qr' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById('success-text').innerText = data.success;
              document.getElementById('success-message').classList.remove('hidden');
              document.getElementById('error-message').classList.add('hidden');
              
              // Clear and restart the scanner
              html5QrcodeScanner.clear().then(() => {
                html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render(onScanSuccess);
              });
            } else if (data.error) {
              document.getElementById('error-text').innerText = data.error;
              document.getElementById('error-message').classList.remove('hidden');
              document.getElementById('success-message').classList.add('hidden');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('error-text').innerText = 'An unexpected error occurred.';
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('success-message').classList.add('hidden');
          });
        }
      });
    </script>

    <!-- Next Button -->
    <button class="next-btn" onclick="location.reload()">Next Registration</button>
  </div>
</div>
{% endblock %}
